package com.yang.parser;

import com.alibaba.fastjson.JSONObject;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.junit.Test;

import static org.junit.Assert.assertEquals;

/**
 * @author yangshen47
 * @description
 * @date 2022/5/10 12:40 上午
 */
public class CodeParserTest {

    @Test
    public void testParseCode(){
        String result = "```java\n" +
                "class ProductService {\n" +
                "  // 访问数据库的对象\n" +
                "  private ProduceRepository repository = new ProductRepository();\n" +
                "  \n" +
                "  public Product find(final long id) {\n" +
                "    return this.repository.find(id);\n" +
                "  }\n" +
                "}\n" +
                "```\n";
        String body = "<div class=\"se-e47854b6\" data-code-language=\"java\" data-slate-type=\"pre\" data-slate-object=\"block\" data-key=\"1681\"><div class=\"se-1669817c se-e488d576\"><span></span></div><div class=\"se-03d5b846\"><div class=\"se-c67c3e0e se-16a618c4\" data-code-line-number=\"1\"></div><div class=\"se-c67c3e0e se-16a618c4\" data-code-line-number=\"2\"></div><div class=\"se-c67c3e0e se-16a618c4\" data-code-line-number=\"3\"></div><div class=\"se-c67c3e0e se-16a618c4\" data-code-line-number=\"4\"></div><div class=\"se-c67c3e0e se-16a618c4\" data-code-line-number=\"5\"></div><div class=\"se-c67c3e0e se-16a618c4\" data-code-line-number=\"6\"></div><div class=\"se-c67c3e0e se-16a618c4\" data-code-line-number=\"7\"></div><div class=\"se-c67c3e0e se-16a618c4\" data-code-line-number=\"8\"></div></div><div class=\"se-6f841771\"><div data-simplebar=\"init\"><div class=\"simplebar-wrapper\" style=\"margin: 0px;\"><div class=\"simplebar-height-auto-observer-wrapper\"><div class=\"simplebar-height-auto-observer\"></div></div><div class=\"simplebar-mask\"><div class=\"simplebar-offset\" style=\"right: 0px; bottom: 0px;\"><div class=\"simplebar-content-wrapper\" style=\"height: auto; overflow: scroll hidden;\"><div class=\"simplebar-content\" style=\"padding: 0px;\"><div data-origin=\"pm_code_preview\"><div class=\"se-16720723 se-6e92e43e\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"1682\"><span data-slate-object=\"text\" data-key=\"1683\"><span data-slate-leaf=\"true\" data-offset-key=\"1683:0\" data-first-offset=\"true\"><span class=\"hljs-class\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span class=\"hljs-keyword\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">class</span></span></span></span></span><span data-slate-object=\"text\" data-key=\"1684\"><span data-slate-leaf=\"true\" data-offset-key=\"1684:0\" data-first-offset=\"true\"><span class=\"hljs-class\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\"> </span></span></span></span><span data-slate-object=\"text\" data-key=\"1685\"><span data-slate-leaf=\"true\" data-offset-key=\"1685:0\" data-first-offset=\"true\"><span class=\"hljs-class\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span class=\"hljs-title\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">ProductService</span></span></span></span></span><span data-slate-object=\"text\" data-key=\"1686\"><span data-slate-leaf=\"true\" data-offset-key=\"1686:0\" data-first-offset=\"true\"><span class=\"hljs-class\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\"> </span></span></span></span><span data-slate-object=\"text\" data-key=\"1687\"><span data-slate-leaf=\"true\" data-offset-key=\"1687:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">{</span></span></span></div><div class=\"se-16720723 se-6e92e43e\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"1688\"><span data-slate-object=\"text\" data-key=\"1689\"><span data-slate-leaf=\"true\" data-offset-key=\"1689:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">  </span></span></span><span data-slate-object=\"text\" data-key=\"1690\"><span data-slate-leaf=\"true\" data-offset-key=\"1690:0\" data-first-offset=\"true\"><span class=\"hljs-comment\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">// 访问数据库的对象</span></span></span></span></div><div class=\"se-16720723 se-6e92e43e\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"1691\"><span data-slate-object=\"text\" data-key=\"1692\"><span data-slate-leaf=\"true\" data-offset-key=\"1692:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">  </span></span></span><span data-slate-object=\"text\" data-key=\"1693\"><span data-slate-leaf=\"true\" data-offset-key=\"1693:0\" data-first-offset=\"true\"><span class=\"hljs-keyword\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">private</span></span></span></span><span data-slate-object=\"text\" data-key=\"1694\"><span data-slate-leaf=\"true\" data-offset-key=\"1694:0\" data-first-offset=\"true\"><span data-slate-string=\"true\"> ProduceRepository repository = </span></span></span><span data-slate-object=\"text\" data-key=\"1695\"><span data-slate-leaf=\"true\" data-offset-key=\"1695:0\" data-first-offset=\"true\"><span class=\"hljs-keyword\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">new</span></span></span></span><span data-slate-object=\"text\" data-key=\"1696\"><span data-slate-leaf=\"true\" data-offset-key=\"1696:0\" data-first-offset=\"true\"><span data-slate-string=\"true\"> ProductRepository();</span></span></span></div><div class=\"se-16720723 se-6e92e43e\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"1697\"><span data-slate-object=\"text\" data-key=\"1698\"><span data-slate-leaf=\"true\" data-offset-key=\"1698:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">  </span></span></span></div><div class=\"se-16720723 se-6e92e43e\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"1699\"><span data-slate-object=\"text\" data-key=\"1700\"><span data-slate-leaf=\"true\" data-offset-key=\"1700:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">  </span></span></span><span data-slate-object=\"text\" data-key=\"1701\"><span data-slate-leaf=\"true\" data-offset-key=\"1701:0\" data-first-offset=\"true\"><span class=\"hljs-function\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span class=\"hljs-keyword\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">public</span></span></span></span></span><span data-slate-object=\"text\" data-key=\"1702\"><span data-slate-leaf=\"true\" data-offset-key=\"1702:0\" data-first-offset=\"true\"><span class=\"hljs-function\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\"> Product </span></span></span></span><span data-slate-object=\"text\" data-key=\"1703\"><span data-slate-leaf=\"true\" data-offset-key=\"1703:0\" data-first-offset=\"true\"><span class=\"hljs-function\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span class=\"hljs-title\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">find</span></span></span></span></span><span data-slate-object=\"text\" data-key=\"1704\"><span data-slate-leaf=\"true\" data-offset-key=\"1704:0\" data-first-offset=\"true\"><span class=\"hljs-function\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span class=\"hljs-params\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">(</span></span></span></span></span><span data-slate-object=\"text\" data-key=\"1705\"><span data-slate-leaf=\"true\" data-offset-key=\"1705:0\" data-first-offset=\"true\"><span class=\"hljs-function\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span class=\"hljs-params\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span class=\"hljs-keyword\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">final</span></span></span></span></span></span><span data-slate-object=\"text\" data-key=\"1706\"><span data-slate-leaf=\"true\" data-offset-key=\"1706:0\" data-first-offset=\"true\"><span class=\"hljs-function\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span class=\"hljs-params\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\"> </span></span></span></span></span><span data-slate-object=\"text\" data-key=\"1707\"><span data-slate-leaf=\"true\" data-offset-key=\"1707:0\" data-first-offset=\"true\"><span class=\"hljs-function\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span class=\"hljs-params\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span class=\"hljs-keyword\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">long</span></span></span></span></span></span><span data-slate-object=\"text\" data-key=\"1708\"><span data-slate-leaf=\"true\" data-offset-key=\"1708:0\" data-first-offset=\"true\"><span class=\"hljs-function\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span class=\"hljs-params\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\"> id)</span></span></span></span></span><span data-slate-object=\"text\" data-key=\"1709\"><span data-slate-leaf=\"true\" data-offset-key=\"1709:0\" data-first-offset=\"true\"><span class=\"hljs-function\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\"> </span></span></span></span><span data-slate-object=\"text\" data-key=\"1710\"><span data-slate-leaf=\"true\" data-offset-key=\"1710:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">{</span></span></span></div><div class=\"se-16720723 se-6e92e43e\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"1711\"><span data-slate-object=\"text\" data-key=\"1712\"><span data-slate-leaf=\"true\" data-offset-key=\"1712:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">    </span></span></span><span data-slate-object=\"text\" data-key=\"1713\"><span data-slate-leaf=\"true\" data-offset-key=\"1713:0\" data-first-offset=\"true\"><span class=\"hljs-keyword\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">return</span></span></span></span><span data-slate-object=\"text\" data-key=\"1714\"><span data-slate-leaf=\"true\" data-offset-key=\"1714:0\" data-first-offset=\"true\"><span data-slate-string=\"true\"> </span></span></span><span data-slate-object=\"text\" data-key=\"1715\"><span data-slate-leaf=\"true\" data-offset-key=\"1715:0\" data-first-offset=\"true\"><span class=\"hljs-keyword\" data-slate-type=\"mark-class\" data-slate-object=\"mark\"><span data-slate-string=\"true\">this</span></span></span></span><span data-slate-object=\"text\" data-key=\"1716\"><span data-slate-leaf=\"true\" data-offset-key=\"1716:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">.repository.find(id);</span></span></span></div><div class=\"se-16720723 se-6e92e43e\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"1717\"><span data-slate-object=\"text\" data-key=\"1718\"><span data-slate-leaf=\"true\" data-offset-key=\"1718:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">  }</span></span></span></div><div class=\"se-16720723 se-6e92e43e\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"1719\"><span data-slate-object=\"text\" data-key=\"1720\"><span data-slate-leaf=\"true\" data-offset-key=\"1720:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">}</span></span></span></div></div></div></div></div></div><div class=\"simplebar-placeholder\" style=\"width: auto; height: 160px;\"></div></div><div class=\"simplebar-track simplebar-horizontal\" style=\"visibility: visible;\"><div class=\"simplebar-scrollbar\" style=\"width: 262px; transform: translate3d(0px, 0px, 0px); display: block;\"></div></div><div class=\"simplebar-track simplebar-vertical\" style=\"visibility: hidden;\"><div class=\"simplebar-scrollbar\" style=\"height: 0px; display: none;\"></div></div></div></div></div>";
        Document document = Jsoup.parseBodyFragment(body);
        Element body1 = document.body();
        BlockParser parser = BlockParser.createBlockParser(body1.child(0));
        JSONObject parse = parser.parse();
        parse.getString("content");
        assertEquals("代码块解析错误",result,parse.getString("content"));
        System.out.println();

    }


    @Test
    public void testParseCodeNoPreviewAttr(){
        String result = "```\n" +
                "<dependency>\n" +
                "    <groupId>org.springframework.boot</groupId>\n" +
                "    <artifactId>spring-boot-starter-actuator</artifactId>\n" +
                "</dependency>\n" +
                "```\n";

        String body = "<div class=\"se-e47dbe45\" data-slate-type=\"pre\" data-slate-object=\"block\" data-key=\"11087\"><div class=\"se-1c7c6838 se-190c89dc\"><span></span></div><div class=\"se-c356aa35\"><div class=\"se-2cb259e2 se-ea6d02c6\" data-code-line-number=\"1\"></div><div class=\"se-2cb259e2 se-ea6d02c6\" data-code-line-number=\"2\"></div><div class=\"se-2cb259e2 se-ea6d02c6\" data-code-line-number=\"3\"></div><div class=\"se-2cb259e2 se-ea6d02c6\" data-code-line-number=\"4\"></div></div><div class=\"se-48224f1c ps ps--active-x\"><div class=\"se-8f3f414d se-c1afbca7\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"11088\"><span data-slate-object=\"text\" data-key=\"11089\"><span data-slate-leaf=\"true\" data-offset-key=\"11089:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">&lt;dependency&gt;</span></span></span></div><div class=\"se-8f3f414d se-c1afbca7\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"11090\"><span data-slate-object=\"text\" data-key=\"11091\"><span data-slate-leaf=\"true\" data-offset-key=\"11091:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span></span></div><div class=\"se-8f3f414d se-c1afbca7\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"11092\"><span data-slate-object=\"text\" data-key=\"11093\"><span data-slate-leaf=\"true\" data-offset-key=\"11093:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span></span></span></div><div class=\"se-8f3f414d se-c1afbca7\" data-slate-type=\"code-line\" data-slate-object=\"block\" data-key=\"11094\"><span data-slate-object=\"text\" data-key=\"11095\"><span data-slate-leaf=\"true\" data-offset-key=\"11095:0\" data-first-offset=\"true\"><span data-slate-string=\"true\">&lt;/dependency&gt;</span></span></span></div><div class=\"ps__rail-x\" style=\"width: 365px; left: 0px; bottom: 0px;\"><div class=\"ps__thumb-x\" tabindex=\"0\" style=\"left: 0px; width: 300px;\"></div></div><div class=\"ps__rail-y\" style=\"top: 0px; right: 0px;\"><div class=\"ps__thumb-y\" tabindex=\"0\" style=\"top: 0px; height: 0px;\"></div></div></div></div>";
        Document document = Jsoup.parseBodyFragment(body);
        Element body1 = document.body();
        BlockParser parser = BlockParser.createBlockParser(body1.child(0));
        JSONObject parse = parser.parse();
        parse.getString("content");
        assertEquals("代码块解析错误",result,parse.getString("content"));


    }
}
